<?php
namespace AMH\Mapper;

use \AMH\Model\Model as AMHModel;

abstract class Mapper{
	protected $reqTables=array();
	protected $items=null;
	protected $pdo;
	private $options=array(
		'getArrayOnly'=>TRUE,
		'fieldsMap'=>array(),
		'storeLastReceived'=>FALSE,
	);
	private $lastUsedFilter=null;
	
	abstract protected function dbSelect($filter);
	abstract protected function dbInsert($item);
	abstract protected function dbSave($item);
	abstract protected function dbDelete($item);
	
	protected function fetch($row){
		$fields=array();
		foreach($row as $key=>$val){
			if(isset($this->options['fieldsMap'][$key])){
				$key=$this->options['fieldsMap'][$key];
			}
			$fields[$key]=$val;
		}
		return new AMHModel($fields);
	}
	
	private function createTables(){
		if(count($this->reqTables)){
			try{
				foreach($this->reqTables as $query){
					$this->pdo->query($query);
				}
				unset($query);
			}
			catch(\PDOException $e){
				throw new \Exception('Invalid table queries given to '.__CLASS__);
				return FALSE;
			}
			return TRUE;
		}
		else{
			throw new \Exception(__CLASS__.' - Cannot use database, table(s) does not exist and no queries to create them defined');
			return FALSE;
		}
	}
	
	public function __construct(\PDO $pdo,array $options=array()){
		$this->pdo=$pdo;
		$this->setOptions($options);
	}
	
	public function setOptions(array $options){
		if(isset($options['getArrayOnly'])){
			$this->options['getArrayOnly']=$options['getArrayOnly'];
		}
		if(isset($options['fieldsMap'])&&is_array($options['fieldsMap'])){
			$this->options['fieldsMap']=$options['fieldsMap'];
		}
		if(isset($options['storeLastReceived'])){
			$this->options['storeLastReceived']=$options['storeLastReceived'];
		}
	}
	
	public function get(array $filter=array()){
		if(is_array($this->items)&&count($this->items)&&$this->options['storeLastReceived']&&$filter==$this->lastUsedFilter){
			return $this->items;
		}
		
		if(!$this->callbacks['selectQuery']){
			throw new \Exception('Select query is no defined in '.__CLASS__.', cannot get models');
			return;
		}
		
		try{
			$res=$this->pdo->query($this->callbacks['selectQuery']($filter));
		}
		catch(\PDOException $e){
			if($e->getCode()=='42S02'){
				if($this->createTables()){
					return $this->get($filter);
				}
				else
					return FALSE;
			}
		}
		
		$items=array();
		$res->setFetchMode(\PDO::FETCH_ASSOC);
		while($row=$res->fetch()){
			$items[]=$this->fetch($row);
		}
		
		if(count($items)==1&&!$this->options['getArrayOnly']){
				$items=$items[0];
		}
		
		if(!count($items)){
			$items=null;
		}
		
		if($this->options['storeLastReceived']){
			$this->items=$items;
			$this->lastUsedFilter=$filter;
		}
		
		return $items;
	}
	
	public function insert($item){
		return $this->manage('Insert',$item);
	}
	
	public function save($item){
		return $this->manage('Save',$item);
	}
	
	public function delete($item){
		return $this->manage('Delete',$item);
	}
	
	private function manage(string $action,$item){
		switch($action){
		case 'Insert':
		case 'Save':
		case 'Delete':
			break;
		default:
			throw new \Exception('Wrong "action" parametr given to '.__CLASS__.'::'.__FUNCTION__);
			return null;
		}
		
		if(!$this->callbacks[$action.'Query']){
			throw new \Exception($action.'Query callback isn\'t given to '.__CLASS__);
			return FALSE;
		}
		try{
			$res=$this->(string)'db'.$action();
		}
		catch(\PDOException $e){
			if($e->getCode()=='42S02'){
				$this->createTables();
				return $this->manage($action,$item);
			}
			else{
				return FALSE;
			}
		}
		
		return TRUE;
	}
}
?>
